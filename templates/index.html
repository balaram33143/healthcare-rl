<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Treatment Optimizer â€“ RL Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 text-gray-900">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <h1 class="text-3xl font-bold text-center">Healthcare Treatment Optimizer</h1>
        <p class="text-center text-sm mt-2">Reinforcement Learning Simulation Demo</p>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-6 space-y-6">

        <!-- Input Card -->
        <section class="bg-white rounded-2xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Simulation Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium">Initial Glucose</label>
                    <input id="glucose" type="number" value="180" min="60" max="300" class="mt-1 p-2 w-full border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">Target Glucose</label>
                    <input id="goal" type="number" value="100" min="70" max="130" class="mt-1 p-2 w-full border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">Timesteps</label>
                    <input id="steps" type="number" value="20" min="5" max="50" class="mt-1 p-2 w-full border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">Action Mode</label>
                    <select id="mode" class="mt-1 p-2 w-full border rounded">
                        <option value="agent">RL Agent (Trained)</option>
                        <option value="random">Random Actions</option>
                        <option value="conservative">Conservative Doctor</option>
                        <option value="manual">Manual Control</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Noise Level</label>
                    <select id="noise" class="mt-1 p-2 w-full border rounded">
                        <option value="1">Low</option>
                        <option value="2" selected>Medium</option>
                        <option value="3">High</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="runSimulation()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
                        Run Simulation
                    </button>
                </div>
            </div>
        </section>

        <!-- Stats and Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Stats Panel -->
            <section class="bg-white rounded-2xl shadow-md p-6 lg:col-span-1">
                <h2 class="text-xl font-semibold mb-4">Simulation Stats</h2>
                <div id="stats" class="space-y-3">
                    <div class="flex justify-between">
                        <span>Initial Glucose:</span>
                        <span id="stat-initial" class="font-semibold">180 mg/dL</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Final Glucose:</span>
                        <span id="stat-final" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Time in Target Range:</span>
                        <span id="stat-target" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Hypoglycemic Events:</span>
                        <span id="stat-hypo" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Hyperglycemic Events:</span>
                        <span id="stat-hyper" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Reward:</span>
                        <span id="stat-reward" class="font-semibold">-</span>
                    </div>
                </div>
            </section>

            <!-- Chart -->
            <section class="bg-white rounded-2xl shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Glucose Levels Over Time</h2>
                <canvas id="glucoseChart" height="250"></canvas>
            </section>
        </div>

        <!-- Log -->
        <section class="bg-white rounded-2xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Simulation Log</h2>
            <div id="log" class="h-60 overflow-y-auto text-sm bg-gray-50 border p-3 rounded font-mono"></div>
            <div class="flex space-x-2 mt-3">
                <button onclick="copyLog()" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">Copy Log</button>
                <button onclick="downloadCSV()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Download CSV</button>
                <button onclick="clearLog()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Clear Log</button>
            </div>
        </section>

    </main>

    <script>
        let chart;
        let simulationData = [];

        // Simple RL agent simulation (since we can't run Python in browser)
        class DiabetesAgent {
            constructor(goal) {
                this.goal = goal;
                this.learnedPolicy = {
                    // This simulates a trained policy that would map states to actions
                    getAction: (state) => {
                        const glucose = state[0];
                        const diff = glucose - this.goal;

                        // Simulate a trained policy with some randomness
                        if (glucose > 240) return 4; // Highest dose for very high glucose
                        if (glucose > 180) return 3; // High dose for high glucose
                        if (glucose > 140) return 2; // Medium dose for elevated glucose
                        if (glucose > 110) return 1; // Low dose for slightly elevated
                        if (glucose > 85) return 0; // No insulin in good range
                        return 0; // No insulin if low or normal
                    }
                };
            }

            predict(state) {
                const action = this.learnedPolicy.getAction(state);
                return [action, null]; // Simulate the output format of Python model.predict()
            }
        }

        function runSimulation() {
            const glucose = parseFloat(document.getElementById('glucose').value);
            const goal = parseFloat(document.getElementById('goal').value);
            const steps = parseInt(document.getElementById('steps').value);
            const mode = document.getElementById('mode').value;
            const noiseLevel = parseInt(document.getElementById('noise').value);

            // Initialize agent if needed
            let agent = null;
            if (mode === "agent") {
                agent = new DiabetesAgent(goal);
            }

            let values = [glucose];
            let actions = [0];
            let rewards = [0];
            let logText = "Step,Glucose,Action,Reward\n0," + glucose.toFixed(2) + ",0,0\n";
            let current = glucose;

            // Stats tracking
            let timeInTarget = 0;
            let hypoEvents = 0;
            let hyperEvents = 0;
            let totalReward = 0;

            for (let i = 1; i <= steps; i++) {
                let action = 0;

                // Determine action based on mode
                if (mode === "agent" && agent) {
                    const [agentAction] = agent.predict([current]);
                    action = agentAction;
                } else if (mode === "random") {
                    action = Math.floor(Math.random() * 5); // 0 to 4
                } else if (mode === "conservative") {
                    // Conservative doctor approach
                    if (current > goal + 30) action = 2;
                    else if (current > goal + 15) action = 1;
                    else action = 0;
                } else if (mode === "manual") {
                    action = prompt(`Manual action for step ${i} (0-4 units):`, "0");
                    action = Math.min(4, Math.max(0, parseInt(action) || 0));
                }

                // Convert action to insulin units (0, 2, 4, 6, 8 units)
                const insulinUnits = action * 2;

                // Calculate glucose change with noise
                const naturalChange = (Math.random() * 10 - 5) * noiseLevel; // Natural fluctuation
                const insulinEffect = -insulinUnits * (0.8 + Math.random() * 0.4); // Insulin effect with variability
                const change = naturalChange + insulinEffect;

                current += change;

                // Ensure glucose stays within reasonable bounds
                current = Math.max(40, Math.min(400, current));

                // Calculate reward
                const reward = -Math.abs(current - goal) / 100;
                totalReward += reward;

                // Track stats
                if (Math.abs(current - goal) < 15) timeInTarget++;
                if (current < 70) hypoEvents++;
                if (current > 180) hyperEvents++;

                values.push(current);
                actions.push(insulinUnits);
                rewards.push(reward);

                logText += `${i},${current.toFixed(2)},${insulinUnits},${reward.toFixed(2)}\n`;
            }

            // Update stats display
            document.getElementById("stat-initial").textContent = glucose.toFixed(1) + " mg/dL";
            document.getElementById("stat-final").textContent = current.toFixed(1) + " mg/dL";
            document.getElementById("stat-target").textContent = timeInTarget + " steps (" + ((timeInTarget / steps) * 100).toFixed(1) + "%)";
            document.getElementById("stat-hypo").textContent = hypoEvents + " events";
            document.getElementById("stat-hyper").textContent = hyperEvents + " events";
            document.getElementById("stat-reward").textContent = totalReward.toFixed(2);

            // Chart update
            const ctx = document.getElementById('glucoseChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: steps + 1
                    }, (_, i) => i),
                    datasets: [{
                        label: 'Glucose Level',
                        data: values,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    }, {
                        label: 'Insulin Dose',
                        data: actions,
                        borderColor: 'rgb(239, 68, 68)',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Timestep'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Glucose Level (mg/dL)'
                            },
                            suggestedMin: 60,
                            suggestedMax: 250
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Insulin Dose (units)'
                            },
                            suggestedMin: 0,
                            suggestedMax: 8,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                targetLine: {
                                    type: 'line',
                                    yMin: goal,
                                    yMax: goal,
                                    borderColor: 'rgb(34, 197, 94)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: 'Target: ' + goal
                                    }
                                },
                                hypoZone: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: 70,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 0,
                                    label: {
                                        display: true,
                                        content: 'Hypoglycemia Risk',
                                        position: 'start'
                                    }
                                },
                                hyperZone: {
                                    type: 'box',
                                    yMin: 180,
                                    yMax: 400,
                                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                    borderWidth: 0,
                                    label: {
                                        display: true,
                                        content: 'Hyperglycemia Risk',
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // Log update
            document.getElementById("log").textContent = logText;
            simulationData = {
                values,
                actions,
                rewards,
                logText,
                stats: {
                    timeInTarget,
                    hypoEvents,
                    hyperEvents,
                    totalReward
                }
            };
        }

        function copyLog() {
            const logText = document.getElementById("log").textContent;
            navigator.clipboard.writeText(logText);
            alert("Log copied to clipboard!");
        }

        function downloadCSV() {
            if (!simulationData.logText) {
                alert("Run a simulation first!");
                return;
            }

            const blob = new Blob([simulationData.logText], {
                type: "text/csv"
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "diabetes_simulation_log.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearLog() {
            document.getElementById("log").textContent = "";
            simulationData = [];

            // Reset stats
            document.getElementById("stat-final").textContent = "-";
            document.getElementById("stat-target").textContent = "-";
            document.getElementById("stat-hypo").textContent = "-";
            document.getElementById("stat-hyper").textContent = "-";
            document.getElementById("stat-reward").textContent = "-";

            // Clear chart
            if (chart) {
                chart.destroy();
                chart = null;
            }
        }

        // Initialize with some sample data
        window.onload = function() {
            // Run a default simulation
            setTimeout(runSimulation, 500);
        };
    </script>

</body>

</html>